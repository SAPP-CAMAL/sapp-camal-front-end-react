name: Admin Frontend CD (No Docker)

on:
  push:
    branches:
      - prod-riobamba

permissions:
  contents: read

jobs:
  build:
    name: Build Next.js app
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # PASO 1: Crear .env para el Build (Vital para NEXT_PUBLIC_*)
      - name: Create .env file for Build
        run: |
          echo "${{ secrets.ENV_FILE }}" | base64 -d > .env

      - name: Install dependencies
        run: npm ci

      - name: Build
        # Ya no necesitamos pasar variables 'env' aquÃ­ manuales,
        # Next las leerÃ¡ del archivo .env que acabamos de crear.
        run: npm run build

      # Comprimimos TODOS los archivos necesarios para producciÃ³n
      - name: Compress Build
        run: |
          tar -czf build.tar.gz \
            --exclude='node_modules/.cache' \
            --exclude='.next/cache' \
            --exclude='node_modules/.bin' \
            .next \
            public \
            src \
            node_modules \
            next.config.ts \
            package.json \
            package-lock.json \
            ecosystem.config.js \
            tsconfig.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: build.tar.gz

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    environment: RIOBAMBA
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: Transfer Build to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "build.tar.gz"
          target: "${{ secrets.APP_DIR }}"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          # Inyectamos el secreto para decodificarlo dentro del servidor
          ENV_FILE: ${{ secrets.ENV_FILE }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: ENV_FILE
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            node -v

            set -euo pipefail
            
            APP_DIR="${{ secrets.APP_DIR }}"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # PASO 2: Crear .env en el Servidor (Vital para PM2 y PORT)
            echo "$ENV_FILE" | base64 -d > .env
            
            # Descomprimir la nueva versiÃ³n
            if [ -f "build.tar.gz" ]; then
              echo "ğŸ“¦ Extrayendo build..."
              # Limpiamos carpetas anteriores de forma segura
              rm -rf .next node_modules public src
            
              # Descomprimimos TODO de una vez
              tar -xzf build.tar.gz
              rm build.tar.gz
              
              echo "âœ… Build extraÃ­do correctamente"
              ls -lah | head -20
            else
              echo "âŒ Error: No se encontrÃ³ el archivo build.tar.gz"
              exit 1
            fi
            
            # Solo actualizar dependencias opcionales si algo falta
            if [ ! -d "node_modules" ]; then
              echo "âš ï¸  Falta node_modules, instalando dependencias..."
              npm ci --omit=dev
            fi
            
            # ğŸ” VERIFICAR ARCHIVOS ESTÃTICOS
            echo ""
            echo "=== Verificando archivos estÃ¡ticos ==="
            if [ -d ".next/static" ]; then
              echo "âœ… Carpeta .next/static existe"
              ls -lah .next/static/ | head -10
              echo ""
              echo "ğŸ“‚ Contenido de .next/static:"
              find .next/static -type f | wc -l
              echo "archivos encontrados"
            else
              echo "âŒ ERROR: Carpeta .next/static NO existe"
              ls -lah .next/ || echo ".next tampoco existe!"
              exit 1
            fi
            
            # Asegurar permisos correctos
            echo ""
            echo "ğŸ” Ajustando permisos..."
            chmod -R 755 .next/static
            chmod -R 755 public
            ls -lah .next/ | grep static
            
            # Iniciar o Recargar PM2
            echo "ğŸ”„ Reiniciando aplicaciÃ³n..."
            
            # Verificar si PM2 estÃ¡ instalado globalmente
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¥ Instalando PM2 globalmente..."
              npm install -g pm2
              pm2 install pm2-logrotate
            fi
            
            # Usar startOrRestart para manejar tanto primer deploy como actualizaciones
            pm2 startOrRestart ecosystem.config.js --update-env
            
            # Verificar que el proceso estÃ© corriendo
            sleep 2
            pm2 status
            
            if pm2 list | grep -q "sapp"; then
              echo "âœ… AplicaciÃ³n iniciada correctamente"
            else
              echo "âŒ Error: La aplicaciÃ³n no se iniciÃ³"
              pm2 logs sapp --lines 20
              exit 1
            fi
            
            pm2 save
            echo "ğŸš€ Despliegue completado exitosamente."